<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Storage - Box</title>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
      import { getDatabase, ref, child, get } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
      import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD5bw3a-mbaoYOwOpCUcODwt77c-cJyWTw",
        authDomain: "boxi-40e55.firebaseapp.com",
        projectId: "boxi-40e55",
        storageBucket: "boxi-40e55.firebasestorage.app",
        messagingSenderId: "777028358786",
        appId: "1:777028358786:web:961e22a3908b689a295a9b"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const storage = getStorage(app);

      function loadUserFiles() {
        const userId = localStorage.getItem("currentUser");
        const filesRef = ref(db, 'users/' + userId + '/files');
        
        get(filesRef).then((snapshot) => {
          const fileList = document.getElementById('file-list');
          if (snapshot.exists()) {
            const files = snapshot.val();
            for (const fileId in files) {
              const file = files[fileId];
              const listItem = document.createElement('li');
              listItem.innerHTML = `File: <a href="${file.url}" target="_blank">${file.name}</a>`;
              fileList.appendChild(listItem);
            }
          } else {
            fileList.innerHTML = "No files uploaded.";
          }
        });
      }

      function uploadFile(event) {
        event.preventDefault();
        const userId = localStorage.getItem("currentUser");
        const file = document.getElementById("file-input").files[0];
        const fileRef = storageRef(storage, 'files/' + userId + '/' + file.name);

        uploadBytes(fileRef, file).then(() => {
          getDownloadURL(fileRef).then((url) => {
            saveFileMetadata(userId, file.name, url);
          });
        }).catch((error) => {
          console.error('Error uploading file:', error);
        });
      }

      function saveFileMetadata(userId, fileName, fileURL) {
        const filesRef = ref(db, 'users/' + userId + '/files');
        const newFileRef = push(filesRef);
        set(newFileRef, {
          name: fileName,
          url: fileURL,
          uploadedAt: new Date().toISOString()
        }).then(() => {
          loadUserFiles();  // Reload the files list
        }).catch((error) => {
          console.error('Error saving file metadata:', error);
        });
      }

      window.onload = loadUserFiles;
    </script>
  </head>
  <body>
    <h1>Storage</h1>
    <form onsubmit="uploadFile(event)">
      <input type="file" id="file-input" required />
      <button type="submit">Upload File</button>
    </form>

    <h2>Your Files:</h2>
    <ul id="file-list"></ul>
  </body>
</html>
